<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homeboard</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            font-family: system-ui, -apple-system, sans-serif;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        @media only screen and (orientation: landscape) {
            body {
                height: 100vh;
            }
        }

        .hidden-section {
            /* margin-bottom: 20px; */
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .hidden-controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .hidden-section input {
            /* padding: 5px; */
        }

        .main-container {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        table {
            width: 100%;
            height: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        td {
            /* padding: 10px; */
            vertical-align: top;
            width: 50%;
        }

        .input-row td {
            height: 3em;
        }

        .input-cell {
            display: flex;
            height: 100%;
            /* gap: 5px; */
        }

        .input-cell textarea {
            flex: 1;
        }

        .input-cell button {
            width: 3em;

        }

        .history-row {
            height: 100%;
        }

        .file-input-wrapper {
            width: 100%;
            height: 100%;
        }

        .file-input-wrapper button {
            width: 100%;
            height: 100%;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        textarea {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            resize: none;
        }

        .history {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            border: 1px solid #ccc;
            /* padding: 10px; */
            box-sizing: border-box;
        }

        .history-item {
            border: 1px solid black;
            padding: 10px;
            /* margin-bottom: 10px; */
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .history-item:hover {
            background-color: #f0f0f0;
        }

        .history-content {
            max-height: 3em;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 50%;
            background-color: #999;
        }

        .status-dot.connected {
            background-color: #4CAF50;
        }

        .status-dot.connecting {
            background-color: #FFC107;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .status-dot.disconnected {
            background-color: #F44336;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }
        }

        .drop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            pointer-events: none;
        }

        .drop-overlay.active {
            display: flex;
        }

        .drop-message {
            font-size: 2em;
            color: white;
            padding: 40px;
            border: 3px dashed white;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>

<body>
    <div class="hidden-section">
        <div class="hidden-controls">
            <input type="password" id="hidden-input" placeholder="Enter hidden text...">
            <button id="submit-hidden">Submit</button>
            <button id="copy-hidden">Copy</button>
        </div>
        <div class="status-indicator">
            <div class="status-dot connecting" id="status-dot" title="Connecting..."></div>
        </div>
    </div>
    
    <div class="main-container">
        <table>
            <tr class="input-row">
                <td>
                    <div class="input-cell">
                        <textarea id="input" placeholder="Type or paste content..."></textarea>
                        <button id="submit">+</button>
                    </div>
                </td>
                <td>
                    <div class="file-input-wrapper">
                        <button id="file-input-display">Browse files...</button>
                        <input type="file" id="file-input" multiple>
                    </div>
                </td>
            </tr>
            <tr class="history-row">
                <td>
                    <div id="text-history" class="history"></div>
                </td>
                <td>
                    <div id="file-history" class="history"></div>
                </td>
            </tr>
        </table>
    </div>

    <div class="drop-overlay" id="drop-overlay">
        <div class="drop-message">Drop files here</div>
    </div>

    <script>
        const input = document.getElementById('input');
        const submitBtn = document.getElementById('submit');
        const hiddenInput = document.getElementById('hidden-input');
        const submitHiddenBtn = document.getElementById('submit-hidden');
        const copyHiddenBtn = document.getElementById('copy-hidden');
        const fileInput = document.getElementById('file-input');
        const fileInputDisplay = document.getElementById('file-input-display');
        const textHistoryContainer = document.getElementById('text-history');
        const fileHistoryContainer = document.getElementById('file-history');
        const statusDot = document.getElementById('status-dot');
        const dropOverlay = document.getElementById('drop-overlay');
        let eventSource = null;
        let dragCounter = 0;

        window.addEventListener('dragenter', (e) => {
            e.preventDefault();
            dragCounter++;
            if (e.dataTransfer.types.includes('Files')) {
                dropOverlay.classList.add('active');
            }
        });

        window.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dragCounter--;
            if (dragCounter === 0) {
                dropOverlay.classList.remove('active');
            }
        });

        window.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        window.addEventListener('drop', (e) => {
            e.preventDefault();
            dragCounter = 0;
            dropOverlay.classList.remove('active');

            if (e.dataTransfer.files.length > 0) {
                uploadFiles(e.dataTransfer.files);
            }
        });

        fileInputDisplay.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                uploadFiles(fileInput.files);
                fileInput.value = '';
            }
        });

        function renderTextHistory(items) {
            textHistoryContainer.innerHTML = '';
            items.forEach((item) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item';
                itemDiv.onclick = () => {
                    copyToClipboard(item);
                };

                const content = document.createElement('div');
                content.className = 'history-content';
                content.textContent = item;

                itemDiv.appendChild(content);
                textHistoryContainer.appendChild(itemDiv);
            });
        }

        function copyToClipboard(text) {
            const input = document.createElement('input');
            input.value = text;
            input.style.position = 'fixed';
            input.style.opacity = '0';
            input.style.pointerEvents = 'none';

            document.body.appendChild(input);

            if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
                const range = document.createRange();
                range.selectNodeContents(input);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
                input.setSelectionRange(0, 999999);
            } else {
                input.select();
            }

            let success = false;
            try {
                success = document.execCommand('copy');
            } catch (err) {
                console.log('Copy failed:', err);
            }

            document.body.removeChild(input);
            return success;
        }

        function renderFileHistory(items) {
            fileHistoryContainer.innerHTML = '';
            items.forEach((item) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'history-item';
                itemDiv.onclick = () => {
                    const link = document.createElement('a');
                    link.href = `/files/${item.stored_name}`;
                    link.download = item.display_name;
                    link.click();
                };

                const filename = document.createElement('div');
                filename.className = 'history-content';
                filename.textContent = item.display_name;

                itemDiv.appendChild(filename);
                fileHistoryContainer.appendChild(itemDiv);
            });
        }

        function connectSSE() {
            eventSource = new EventSource('/events');

            eventSource.onopen = () => {
                statusDot.className = 'status-dot connected';
                statusDot.title = 'Connected';
            };

            eventSource.addEventListener('update', (event) => {
                const data = JSON.parse(event.data);
                renderTextHistory(data.text_items);
                renderFileHistory(data.file_items);
            });

            eventSource.onerror = () => {
                statusDot.className = 'status-dot disconnected';
                statusDot.title = 'Disconnected';
                eventSource.close();
                setTimeout(() => {
                    statusDot.className = 'status-dot connecting';
                    statusDot.title = 'Connecting...';
                    connectSSE();
                }, 3000);
            };
        }

        async function sendUpdate(content) {
            try {
                await fetch('/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content }),
                });
            } catch (error) {
                console.error('Failed to send update:', error);
            }
        }

        async function uploadFiles(files) {
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData,
                    });
                    if (!response.ok) {
                        console.error('Upload failed:', response.status, await response.text());
                    }
                } catch (error) {
                    console.error('Failed to upload file:', error);
                }
            }
        }

        submitBtn.addEventListener('click', () => {
            const content = input.value;
            if (content) {
                sendUpdate(content);
                input.value = '';
            }
        });

        submitHiddenBtn.addEventListener('click', async () => {
            const content = hiddenInput.value;
            try {
                await fetch('/hidden', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content }),
                });
                hiddenInput.value = '';
            } catch (error) {
                console.error('Failed to submit hidden text:', error);
            }
        });

        copyHiddenBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/hidden');
                const data = await response.json();
                if (data.content) {
                    await navigator.clipboard.writeText(data.content);
                }
            } catch (error) {
                console.error('Failed to copy hidden text:', error);
            }
        });

        connectSSE();
    </script>
</body>

</html>